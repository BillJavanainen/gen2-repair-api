<script>
const state = {
  componentChanges: [],
  configChanges: []
};

function el(id){ return document.getElementById(id); }

function getApiBase(){
  return el("apiBase").value.trim().replace(/\/+$/, "");
}

function getApiKey(){
  return el("apiKey").value.trim();
}

async function apiFetch(path, method, body){
  const res = await fetch(getApiBase() + path, {
    method: method,
    headers: {
      "Content-Type": "application/json",
      "X-API-Key": getApiKey()
    },
    body: body ? JSON.stringify(body) : null
  });

  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { data = text; }

  if (!res.ok) {
    throw new Error(typeof data === "string" ? data : JSON.stringify(data));
  }
  return data;
}

function renderChanges(){
  const tbody = el("changesTable").querySelector("tbody");
  tbody.innerHTML="";
  state.componentChanges.forEach((c,i)=>{
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${c.subsystem}</td>
        <td>${c.component}</td>
        <td>${c.oldSn}</td>
        <td>${c.newSn}</td>
      </tr>`;
  });
}

function renderCfg(){
  const tbody = el("cfgTable").querySelector("tbody");
  tbody.innerHTML="";
  state.configChanges.forEach((c,i)=>{
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${c.system}</td>
        <td>${c.param}</td>
      </tr>`;
  });
}

el("addChangeBtn").onclick = ()=>{
  state.componentChanges.push({
    subsystem:el("chgSubsystem").value,
    component:el("chgComponent").value,
    oldSn:el("chgOldSn").value,
    newSn:el("chgNewSn").value,
    oldFw:el("chgOldFw").value,
    newFw:el("chgNewFw").value,
    reason:el("chgReason").value,
    tech:el("chgTech").value
  });
  renderChanges();
};

el("addCfgBtn").onclick = ()=>{
  state.configChanges.push({
    system:el("cfgSystem").value,
    param:el("cfgParam").value,
    oldVal:el("cfgOld").value,
    newVal:el("cfgNew").value,
    reason:el("cfgReason").value
  });
  renderCfg();
};

el("submitDbBtn").onclick = async ()=>{
  try{
    const repair = await apiFetch("/repairs","POST",{
      hull_id: el("hullId").value,
      date_opened: el("dateOpened").value,
      location: el("location").value,
      technicians: el("techs").value,
      service_type: el("serviceType").value,
      issue_desc: el("issueDesc").value
    });

    const uid = repair.repair_uid;
    if(!uid) throw new Error("repair_uid missing from response");

    for(const c of state.configChanges){
      await apiFetch(`/repairs/${uid}/config-changes`,"POST",{
        system:c.system,
        parameter:c.param,
        old_value:c.oldVal,
        new_value:c.newVal,
        notes:c.reason
      });
    }

    for(const c of state.componentChanges){
      await apiFetch(`/repairs/${uid}/component-changes`,"POST",{
        subsystem:c.subsystem,
        component:c.component,
        old_serial:c.oldSn,
        new_serial:c.newSn,
        old_fw:c.oldFw,
        new_fw:c.newFw,
        reason:c.reason,
        performed_by:c.tech
      });
    }

    alert("Submitted successfully.");
  }catch(e){
    alert("Error: " + e.message);
    console.error(e);
  }
};
</script>
