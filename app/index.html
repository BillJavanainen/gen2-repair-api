<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gen2 Repair & Configuration Change Form</title>
<style>
body{font-family:Arial;margin:0;background:#0b0f14;color:#e8eef8;padding:20px}
.card{background:#121825;padding:15px;margin-bottom:15px;border-radius:10px}
input,select,textarea{width:100%;padding:8px;margin-top:4px;margin-bottom:10px;background:#0b111b;color:#e8eef8;border:1px solid #233044;border-radius:6px}
button{padding:8px 12px;border-radius:6px;border:1px solid #233044;background:#0b111b;color:#e8eef8;cursor:pointer}
button.primary{background:#6ea8fe;color:black}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border-bottom:1px solid #233044;padding:6px;font-size:12px}
</style>
</head>
<body>

<h2>Gen2 Repair & Configuration Change Form</h2>

<div class="card">
<h3>API</h3>
<input id="apiBase" value="https://gen2-repair-api-2.onrender.com" />
<button class="primary" id="submitDbBtn">Submit to Database</button>
</div>

<div class="card">
<h3>Repair Info</h3>
<label>Hull ID</label>
<input id="hullId" />
<label>Date Opened</label>
<input id="dateOpened" type="date" />
<label>Location</label>
<input id="location" />
<label>Technicians</label>
<input id="techs" />
<label>Service Type</label>
<input id="serviceType" />
<label>Issue Description</label>
<textarea id="issueDesc"></textarea>
</div>

<div class="card">
<h3>Component Changes</h3>
<input id="chgSubsystem" placeholder="Subsystem" />
<input id="chgComponent" placeholder="Component" />
<input id="chgOldSn" placeholder="Old Serial" />
<input id="chgNewSn" placeholder="New Serial" />
<input id="chgOldFw" placeholder="Old FW" />
<input id="chgNewFw" placeholder="New FW" />
<input id="chgReason" placeholder="Reason" />
<input id="chgTech" placeholder="Technician" />
<button id="addChangeBtn">Add Component Change</button>

<table id="changesTable">
<thead>
<tr><th>#</th><th>Subsystem</th><th>Component</th><th>Old SN</th><th>New SN</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="card">
<h3>Config Changes</h3>
<input id="cfgSystem" placeholder="System" />
<input id="cfgParam" placeholder="Parameter" />
<input id="cfgOld" placeholder="Old Value" />
<input id="cfgNew" placeholder="New Value" />
<input id="cfgReason" placeholder="Reason" />
<button id="addCfgBtn">Add Config Change</button>

<table id="cfgTable">
<thead>
<tr><th>#</th><th>System</th><th>Parameter</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const state = {
  componentChanges: [],
  configChanges: []
};

function el(id){ return document.getElementById(id); }

function getApiBase(){
  return el("apiBase").value.trim().replace(/\/+$/, "");
}

async function apiFetch(path, method, body){
  const res = await fetch(getApiBase()+path,{
    method:method,
    headers:{"Content-Type":"application/json"},
    body: body ? JSON.stringify(body) : null
  });
  const txt = await res.text();
  let data;
  try{ data = JSON.parse(txt); }catch{ data = txt; }
  if(!res.ok) throw new Error(txt);
  return data;
}

function renderChanges(){
  const tbody = el("changesTable").querySelector("tbody");
  tbody.innerHTML="";
  state.componentChanges.forEach((c,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${i+1}</td>
      <td>${c.subsystem}</td>
      <td>${c.component}</td>
      <td>${c.oldSn}</td>
      <td>${c.newSn}</td>
    </tr>`;
  });
}

function renderCfg(){
  const tbody = el("cfgTable").querySelector("tbody");
  tbody.innerHTML="";
  state.configChanges.forEach((c,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${i+1}</td>
      <td>${c.system}</td>
      <td>${c.param}</td>
    </tr>`;
  });
}

el("addChangeBtn").onclick = ()=>{
  state.componentChanges.push({
    subsystem:el("chgSubsystem").value,
    component:el("chgComponent").value,
    oldSn:el("chgOldSn").value,
    newSn:el("chgNewSn").value,
    oldFw:el("chgOldFw").value,
    newFw:el("chgNewFw").value,
    reason:el("chgReason").value,
    tech:el("chgTech").value
  });
  renderChanges();
};

el("addCfgBtn").onclick = ()=>{
  state.configChanges.push({
    system:el("cfgSystem").value,
    param:el("cfgParam").value,
    oldVal:el("cfgOld").value,
    newVal:el("cfgNew").value,
    reason:el("cfgReason").value
  });
  renderCfg();
};

el("submitDbBtn").onclick = async ()=>{
  try{
    const repair = await apiFetch("/repairs","POST",{
      hull_id: el("hullId").value,
      date_opened: el("dateOpened").value,
      location: el("location").value,
      technicians: el("techs").value,
      service_type: el("serviceType").value,
      issue_desc: el("issueDesc").value
    });

    const uid = repair.repair_uid;

    for(const c of state.configChanges){
      await apiFetch(`/repairs/${uid}/config-changes`,"POST",{
        system:c.system,
        parameter:c.param,
        old_value:c.oldVal,
        new_value:c.newVal,
        notes:c.reason
      });
    }

    for(const c of state.componentChanges){
      await apiFetch(`/repairs/${uid}/component-changes`,"POST",{
        subsystem:c.subsystem,
        component:c.component,
        old_serial:c.oldSn,
        new_serial:c.newSn,
        old_fw:c.oldFw,
        new_fw:c.newFw,
        reason:c.reason,
        performed_by:c.tech
      });
    }

    alert("Submitted successfully.");
  }catch(e){
    alert("Error: "+e.message);
  }
};
</script>
</body>
</html>
