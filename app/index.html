<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gen2 Repair & Configuration Change Form</title>
  <style>
    :root { --bg:#0b0f14; --card:#121825; --muted:#8fa0b8; --text:#e8eef8; --line:#233044; --accent:#6ea8fe; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:linear-gradient(180deg,#070a0f 0%, #0b0f14 100%); color:var(--text);
    }
    header{
      padding:20px 18px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(11,15,20,.92); backdrop-filter: blur(10px); z-index:10;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:0 14px; }
    h1{ margin:0 0 6px 0; font-size:18px; font-weight:700; }
    .sub{ margin:0; color:var(--muted); font-size:12px; }
    main{ padding:18px 0 40px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media(min-width:980px){ .grid{ grid-template-columns: 1fr 1fr; } .full{ grid-column:1/-1; } }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 10px 0; font-size:14px; letter-spacing:.2px; }
    .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width:720px){ .row{ grid-template-columns: 1fr 1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, textarea, select{
      width:100%; border-radius:10px; border:1px solid var(--line); background:#0b111b; color:var(--text);
      padding:10px 10px; font-size:13px; outline:none;
    }
    textarea{ min-height:90px; resize:vertical; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    button{
      border:1px solid var(--line); background:#0b111b; color:var(--text);
      padding:9px 11px; border-radius:10px; cursor:pointer; font-size:13px;
    }
    button.primary{ background:rgba(110,168,254,.15); border-color:rgba(110,168,254,.35); }
    button.danger{ background:rgba(255,99,99,.12); border-color:rgba(255,99,99,.3); }
    button:hover{ border-color:#395072; }
    .tiny{ font-size:11px; color:var(--muted); }
    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; }
    th, td{
      border-bottom:1px solid var(--line); padding:8px 8px; vertical-align:top; font-size:12px;
    }
    th{ color:var(--muted); font-weight:600; text-align:left; }
    tr:last-child td{ border-bottom:none; }
    .pill{ display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted); font-size:11px;
    }
    .checks{ display:grid; grid-template-columns:1fr; gap:8px; }
    @media(min-width:720px){ .checks{ grid-template-columns:1fr 1fr; } }
    .check{
      display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px solid var(--line);
      border-radius:12px; background:#0b111b;
    }
    .check input{ width:18px; height:18px; margin-top:2px; }
    .right{ display:flex; gap:10px; align-items:center; justify-content:flex-end; }
    .statusline{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .hidden{ display:none; }
  </style>
</head>
<body>
<header>
  <div class="wrap statusline">
    <div>
      <h1>Gen2 Repair & Configuration Change Form</h1>
      <p class="sub">Autosaves locally • Export JSON/CSV • Import JSON • Single-file offline capable</p>
    </div>
    <div class="right">
      <span id="savePill" class="pill">● <span class="mono" id="saveState">saved</span></span>
      <button class="danger" id="resetBtn" title="Clear local draft">Reset Draft</button>
      <button class="primary" id="exportJsonBtn">Export JSON</button>
      <button id="importJsonBtn">Import JSON</button>
      <input type="file" id="importFile" class="hidden" accept="application/json" />
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <section class="card">
      <h2>1) Vessel Information</h2>
      <div class="row">
        <div>
          <label>Hull ID (R###)</label>
          <input id="hullId" placeholder="R132" />
        </div>
        <div>
          <label>Location</label>
          <input id="location" placeholder="Rumford / Spaceport / Field Site" />
        </div>
        <div>
          <label>Date Opened</label>
          <input id="dateOpened" type="date" />
        </div>
        <div>
          <label>Work Order / Ticket #</label>
          <input id="ticket" placeholder="OPS-#### / JIRA / Email thread" />
        </div>
        <div>
          <label>Technician(s)</label>
          <input id="techs" placeholder="Name(s)" />
        </div>
        <div>
          <label>Mission / Program</label>
          <input id="program" placeholder="SCUS / BlueTide / Test" />
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) Reason for Service</h2>
      <div class="row">
        <div>
          <label>Service Type</label>
          <select id="serviceType">
            <option value="">—</option>
            <option>Failure</option>
            <option>Preventative Maintenance</option>
            <option>Upgrade</option>
            <option>Investigation / Troubleshooting</option>
            <option>Configuration Standardization</option>
            <option>Post-Incident Repair</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>Root Cause Category</label>
          <select id="rootCauseCat">
            <option value="">—</option>
            <option>Electrical</option>
            <option>Mechanical</option>
            <option>Corrosion</option>
            <option>Firmware</option>
            <option>Configuration</option>
            <option>Installation Error</option>
            <option>Water Ingress</option>
            <option>Unknown</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Reported Issue / Description</label>
        <textarea id="issueDesc" placeholder="Symptoms, conditions, logs, UI errors, Grafana notes..."></textarea>
      </div>
      <div style="margin-top:10px">
        <label>Root Cause Details (if determined)</label>
        <textarea id="rootCauseDetails" placeholder="What was wrong and why?"></textarea>
      </div>
    </section>

    <section class="card full">
      <h2>3) Component Change Log</h2>

      <div class="row">
        <div>
          <label>Subsystem</label>
          <select id="chgSubsystem">
            <option value="">—</option>
            <option>Ilmor</option>
            <option>ICU</option>
            <option>HMI Box</option>
            <option>Kitbox</option>
            <option>Orca</option>
            <option>Battery</option>
            <option>PDB</option>
            <option>MPPT</option>
            <option>Camera</option>
            <option>Radar</option>
            <option>Compass</option>
            <option>LTE/Starlink</option>
            <option>Harness/Cabling</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>Component</label>
          <input id="chgComponent" placeholder="Outboard / Distribution Board / M12 Cable / etc." />
        </div>
        <div>
          <label>Old Serial #</label>
          <input id="chgOldSn" placeholder="E700059 / 0000423IL01090 / ..." />
        </div>
        <div>
          <label>New Serial #</label>
          <input id="chgNewSn" placeholder="E700108 / 0000332IL01090 / ..." />
        </div>
        <div>
          <label>Old FW / SW</label>
          <input id="chgOldFw" placeholder="1.1.11-b1 / f9acdb55 / 0.8.4+prod / ..." />
        </div>
        <div>
          <label>New FW / SW</label>
          <input id="chgNewFw" placeholder="1.1.11-c.1 / 1749c27c / ..." />
        </div>
      </div>

      <div style="margin-top:10px" class="row">
        <div>
          <label>Reason for Change</label>
          <input id="chgReason" placeholder="No RPM, water ingress, corrosion, upgrade, etc." />
        </div>
        <div>
          <label>Date</label>
          <input id="chgDate" type="date" />
        </div>
        <div>
          <label>Technician</label>
          <input id="chgTech" placeholder="Name" />
        </div>
        <div style="display:flex; align-items:end; gap:8px;">
          <button class="primary" id="addChangeBtn" style="width:100%;">Add Change</button>
        </div>
      </div>

      <div class="btnbar">
        <button id="exportChangesCsvBtn">Export Changes CSV</button>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table id="changesTable">
          <thead>
          <tr>
            <th>#</th>
            <th>Subsystem</th>
            <th>Component</th>
            <th>Old SN</th>
            <th>New SN</th>
            <th>Old FW</th>
            <th>New FW</th>
            <th>Reason</th>
            <th>Date</th>
            <th>Tech</th>
            <th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="tiny">Tip: Use this table as the authoritative “serial lineage” record for each repair event.</p>
    </section>

    <section class="card full">
      <h2>4) Configuration & Parameter Changes (Non-Hardware)</h2>

      <div class="row">
        <div>
          <label>System</label>
          <select id="cfgSystem">
            <option value="">—</option>
            <option>Ilmor</option>
            <option>ArduPilot</option>
            <option>Balena</option>
            <option>Orca</option>
            <option>Mission Planner</option>
            <option>Kitbox</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>Parameter / Setting</label>
          <input id="cfgParam" placeholder="ESTOP pins / BTN param / RC6 / ILMOR_TRIM_STP / power limit / ..." />
        </div>
        <div>
          <label>Old Value</label>
          <input id="cfgOld" placeholder="50" />
        </div>
        <div>
          <label>New Value</label>
          <input id="cfgNew" placeholder="51" />
        </div>
        <div>
          <label>Reason</label>
          <input id="cfgReason" placeholder="Phantom estop mitigation, unlock power, etc." />
        </div>
        <div style="display:flex; align-items:end;">
          <button class="primary" id="addCfgBtn" style="width:100%;">Add Config Change</button>
        </div>
      </div>

      <div class="btnbar">
        <button id="exportCfgCsvBtn">Export Config CSV</button>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table id="cfgTable">
          <thead>
          <tr>
            <th>#</th>
            <th>System</th>
            <th>Parameter</th>
            <th>Old</th>
            <th>New</th>
            <th>Reason</th>
            <th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>5) Wiring / Harness Notes</h2>
      <textarea id="wiringNotes" placeholder="Cables replaced, corrosion found, dielectric grease applied, reroutes, pin repairs, fuse replacements..."></textarea>
    </section>

    <section class="card">
      <h2>6) Structural / Hull Work</h2>
      <textarea id="structNotes" placeholder="Gelcoat, flange, mounts, steering alignment, trim unit repair, etc."></textarea>
    </section>

    <section class="card full">
      <h2>7) Verification Checklist</h2>
      <div class="checks" id="checks"></div>
      <div style="margin-top:10px">
        <label>Verification Notes</label>
        <textarea id="verifyNotes" placeholder="Checkout play results, water test notes, anomalies, etc."></textarea>
      </div>
    </section>

    <section class="card full">
      <h2>8) Closeout Snapshot</h2>
      <div class="row">
        <div><label>Final Status</label>
          <select id="finalStatus">
            <option value="">—</option>
            <option>Operational</option>
            <option>Operational with Limitation</option>
            <option>Pending Parts</option>
            <option>Out of Service</option>
          </select>
        </div>
        <div><label>Limitations / Notes</label>
          <input id="limitations" placeholder="Power limited, no water test, waiting on cable, etc." />
        </div>
        <div><label>Ilmor SN</label><input id="snapIlmorSn" /></div>
        <div><label>Ilmor FW</label><input id="snapIlmorFw" /></div>
        <div><label>ICU SN</label><input id="snapIcuSn" /></div>
        <div><label>Orca SN</label><input id="snapOrcaSn" /></div>
        <div><label>Battery SN(s)</label><input id="snapBatSns" placeholder="Comma-separated" /></div>
        <div><label>Camera Configuration</label><input id="snapCamera" placeholder="ZED / DWE 3-cam / ..." /></div>
        <div><label>Radar Installed</label>
          <select id="snapRadar"><option value="">—</option><option>Yes</option><option>No</option></select>
        </div>
        <div><label>Compass Installed</label>
          <select id="snapCompass"><option value="">—</option><option>Yes</option><option>No</option></select>
        </div>
        <div><label>Two Battery Config</label>
          <select id="snap2Bat"><option value="">—</option><option>Yes</option><option>No</option></select>
        </div>
      </div>

      <div class="btnbar">
        <button id="exportSummaryCsvBtn">Export Summary CSV</button>
        <button class="primary" id="printBtn">Print / Save PDF</button>
      </div>

      <p class="tiny">Print uses your browser print dialog (works well for “Save as PDF”).</p>
    </section>

  </div>
</main>

<script>
  const LS_KEY = "gen2_repair_form_v1";

  const checklistItems = [
    "No battery faults",
    "Ilmor powers on",
    "No inverter errors",
    "ICU responsive",
    "HMI operational",
    "Trim functional",
    "Action button functional",
    "E-stop verified",
    "Telemetry reporting",
    "Manual RPM test",
    "Trim sweep full range",
    "Steering homing test",
    "Autonomy checkout play",
    "Data logging verified",
    "Grafana reporting",
    "Hand controller verified",
    "Water test complete (if applicable)",
    "Recovered safely (if applicable)"
  ];

  const el = (id) => document.getElementById(id);
  const saveState = el("saveState");
  const savePill = el("savePill");

  const state = {
    meta: {},
    componentChanges: [],
    configChanges: [],
    checklist: {},
  };

  function nowISODate() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function markSaving() {
    saveState.textContent = "saving…";
    savePill.style.borderColor = "rgba(110,168,254,.35)";
  }
  function markSaved() {
    saveState.textContent = "saved";
    savePill.style.borderColor = "var(--line)";
  }

  function gatherMeta() {
    return {
      hullId: el("hullId").value.trim(),
      location: el("location").value.trim(),
      dateOpened: el("dateOpened").value,
      ticket: el("ticket").value.trim(),
      techs: el("techs").value.trim(),
      program: el("program").value.trim(),
      serviceType: el("serviceType").value,
      rootCauseCat: el("rootCauseCat").value,
      issueDesc: el("issueDesc").value.trim(),
      rootCauseDetails: el("rootCauseDetails").value.trim(),
      wiringNotes: el("wiringNotes").value.trim(),
      structNotes: el("structNotes").value.trim(),
      verifyNotes: el("verifyNotes").value.trim(),
      finalStatus: el("finalStatus").value,
      limitations: el("limitations").value.trim(),
      snapshot: {
        ilmorSn: el("snapIlmorSn").value.trim(),
        ilmorFw: el("snapIlmorFw").value.trim(),
        icuSn: el("snapIcuSn").value.trim(),
        orcaSn: el("snapOrcaSn").value.trim(),
        batterySns: el("snapBatSns").value.trim(),
        camera: el("snapCamera").value.trim(),
        radar: el("snapRadar").value,
        compass: el("snapCompass").value,
        twoBattery: el("snap2Bat").value,
      },
      updatedAt: new Date().toISOString()
    };
  }

  function applyMeta(meta) {
    el("hullId").value = meta.hullId || "";
    el("location").value = meta.location || "";
    el("dateOpened").value = meta.dateOpened || "";
    el("ticket").value = meta.ticket || "";
    el("techs").value = meta.techs || "";
    el("program").value = meta.program || "";
    el("serviceType").value = meta.serviceType || "";
    el("rootCauseCat").value = meta.rootCauseCat || "";
    el("issueDesc").value = meta.issueDesc || "";
    el("rootCauseDetails").value = meta.rootCauseDetails || "";
    el("wiringNotes").value = meta.wiringNotes || "";
    el("structNotes").value = meta.structNotes || "";
    el("verifyNotes").value = meta.verifyNotes || "";
    el("finalStatus").value = meta.finalStatus || "";
    el("limitations").value = meta.limitations || "";

    const s = meta.snapshot || {};
    el("snapIlmorSn").value = s.ilmorSn || "";
    el("snapIlmorFw").value = s.ilmorFw || "";
    el("snapIcuSn").value = s.icuSn || "";
    el("snapOrcaSn").value = s.orcaSn || "";
    el("snapBatSns").value = s.batterySns || "";
    el("snapCamera").value = s.camera || "";
    el("snapRadar").value = s.radar || "";
    el("snapCompass").value = s.compass || "";
    el("snap2Bat").value = s.twoBattery || "";
  }

  function saveToLocal() {
    markSaving();
    state.meta = gatherMeta();
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    setTimeout(markSaved, 120);
  }

  function loadFromLocal() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    try {
      const data = JSON.parse(raw);
      Object.assign(state, data);
      applyMeta(state.meta || {});
      renderAll();
      return true;
    } catch {
      return false;
    }
  }

  function download(filename, text) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type:"text/plain"}));
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function toCSV(rows) {
    const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
    return rows.map(r => r.map(esc).join(",")).join("\n");
  }

  function exportJson() {
    const data = { ...state, meta: gatherMeta() };
    const hull = (data.meta?.hullId || "R###").replaceAll(" ","_");
    download(`gen2_repair_${hull}_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(data, null, 2));
  }

  function importJson(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        Object.assign(state, data);
        applyMeta(state.meta || {});
        renderAll();
        saveToLocal();
        alert("Imported JSON successfully.");
      }catch(e){
        alert("Import failed: invalid JSON.");
      }
    };
    reader.readAsText(file);
  }

  function renderChecklist() {
    const root = el("checks");
    root.innerHTML = "";
    checklistItems.forEach((item) => {
      const id = "chk_" + item.replaceAll(/[^a-zA-Z0-9]+/g, "_");
      const wrap = document.createElement("div");
      wrap.className = "check";
      wrap.innerHTML = `
        <input type="checkbox" id="${id}">
        <div>
          <div style="font-size:13px;">${item}</div>
          <div class="tiny">Mark when verified.</div>
        </div>
      `;
      root.appendChild(wrap);
      const cb = document.getElementById(id);
      cb.checked = !!state.checklist[item];
      cb.addEventListener("change", () => {
        state.checklist[item] = cb.checked;
        saveToLocal();
      });
    });
  }

  function renderChanges() {
    const tbody = el("changesTable").querySelector("tbody");
    tbody.innerHTML = "";
    state.componentChanges.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${idx+1}</td>
        <td>${c.subsystem || ""}</td>
        <td>${c.component || ""}</td>
        <td class="mono">${c.oldSn || ""}</td>
        <td class="mono">${c.newSn || ""}</td>
        <td class="mono">${c.oldFw || ""}</td>
        <td class="mono">${c.newFw || ""}</td>
        <td>${c.reason || ""}</td>
        <td class="mono">${c.date || ""}</td>
        <td>${c.tech || ""}</td>
        <td><button class="danger" data-del="${idx}">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        state.componentChanges.splice(i, 1);
        renderChanges();
        saveToLocal();
      });
    });
  }

  function renderCfg() {
    const tbody = el("cfgTable").querySelector("tbody");
    tbody.innerHTML = "";
    state.configChanges.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${idx+1}</td>
        <td>${c.system || ""}</td>
        <td class="mono">${c.param || ""}</td>
        <td class="mono">${c.oldVal || ""}</td>
        <td class="mono">${c.newVal || ""}</td>
        <td>${c.reason || ""}</td>
        <td><button class="danger" data-del="${idx}">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        state.configChanges.splice(i, 1);
        renderCfg();
        saveToLocal();
      });
    });
  }

  function renderAll() {
    renderChecklist();
    renderChanges();
    renderCfg();
  }

  function addComponentChange() {
    const entry = {
      subsystem: el("chgSubsystem").value,
      component: el("chgComponent").value.trim(),
      oldSn: el("chgOldSn").value.trim(),
      newSn: el("chgNewSn").value.trim(),
      oldFw: el("chgOldFw").value.trim(),
      newFw: el("chgNewFw").value.trim(),
      reason: el("chgReason").value.trim(),
      date: el("chgDate").value || nowISODate(),
      tech: el("chgTech").value.trim(),
    };
    if (!entry.subsystem && !entry.component) return alert("Add at least a subsystem or component.");
    state.componentChanges.unshift(entry);
    renderChanges();
    saveToLocal();

    // clear minimal fields for next entry
    el("chgComponent").value = "";
    el("chgOldSn").value = "";
    el("chgNewSn").value = "";
    el("chgOldFw").value = "";
    el("chgNewFw").value = "";
    el("chgReason").value = "";
    el("chgTech").value = "";
  }

  function addCfgChange() {
    const entry = {
      system: el("cfgSystem").value,
      param: el("cfgParam").value.trim(),
      oldVal: el("cfgOld").value.trim(),
      newVal: el("cfgNew").value.trim(),
      reason: el("cfgReason").value.trim(),
    };
    if (!entry.system && !entry.param) return alert("Add at least a system or parameter.");
    state.configChanges.unshift(entry);
    renderCfg();
    saveToLocal();

    el("cfgParam").value = "";
    el("cfgOld").value = "";
    el("cfgNew").value = "";
    el("cfgReason").value = "";
  }

  function exportChangesCSV() {
    const hull = (gatherMeta().hullId || "R###").replaceAll(" ","_");
    const rows = [["Hull","Subsystem","Component","Old Serial","New Serial","Old FW","New FW","Reason","Date","Tech"]];
    state.componentChanges.forEach(c => rows.push([
      hull, c.subsystem, c.component, c.oldSn, c.newSn, c.oldFw, c.newFw, c.reason, c.date, c.tech
    ]));
    download(`gen2_changes_${hull}.csv`, toCSV(rows));
  }

  function exportCfgCSV() {
    const hull = (gatherMeta().hullId || "R###").replaceAll(" ","_");
    const rows = [["Hull","System","Parameter","Old Value","New Value","Reason"]];
    state.configChanges.forEach(c => rows.push([hull, c.system, c.param, c.oldVal, c.newVal, c.reason]));
    download(`gen2_config_${hull}.csv`, toCSV(rows));
  }

  function exportSummaryCSV() {
    const m = gatherMeta();
    const hull = (m.hullId || "R###").replaceAll(" ","_");
    const rows = [
      ["Field","Value"],
      ["Hull ID", m.hullId],
      ["Location", m.location],
      ["Date Opened", m.dateOpened],
      ["Ticket", m.ticket],
      ["Technicians", m.techs],
      ["Program", m.program],
      ["Service Type", m.serviceType],
      ["Root Cause Category", m.rootCauseCat],
      ["Final Status", m.finalStatus],
      ["Limitations", m.limitations],
      ["Snapshot: Ilmor SN", m.snapshot.ilmorSn],
      ["Snapshot: Ilmor FW", m.snapshot.ilmorFw],
      ["Snapshot: ICU SN", m.snapshot.icuSn],
      ["Snapshot: Orca SN", m.snapshot.orcaSn],
      ["Snapshot: Battery SNs", m.snapshot.batterySns],
      ["Snapshot: Camera", m.snapshot.camera],
      ["Snapshot: Radar", m.snapshot.radar],
      ["Snapshot: Compass", m.snapshot.compass],
      ["Snapshot: Two Battery", m.snapshot.twoBattery],
      ["Updated At", m.updatedAt]
    ];
    download(`gen2_summary_${hull}.csv`, toCSV(rows));
  }

  function resetDraft() {
    if (!confirm("Clear the saved draft in this browser?")) return;
    localStorage.removeItem(LS_KEY);
    location.reload();
  }

  function wireAutosave() {
    const ids = [
      "hullId","location","dateOpened","ticket","techs","program",
      "serviceType","rootCauseCat","issueDesc","rootCauseDetails",
      "wiringNotes","structNotes","verifyNotes",
      "finalStatus","limitations",
      "snapIlmorSn","snapIlmorFw","snapIcuSn","snapOrcaSn","snapBatSns","snapCamera",
      "snapRadar","snapCompass","snap2Bat"
    ];
    ids.forEach(id => {
      const node = el(id);
      node.addEventListener("input", saveToLocal);
      node.addEventListener("change", saveToLocal);
    });
  }

  // init
  (function init(){
    renderChecklist();
    if (!el("dateOpened").value) el("dateOpened").value = nowISODate();
    if (!loadFromLocal()) {
      // Initialize checklist defaults
      checklistItems.forEach(i => state.checklist[i] = false);
      saveToLocal();
    }
    wireAutosave();

    el("addChangeBtn").addEventListener("click", addComponentChange);
    el("addCfgBtn").addEventListener("click", addCfgChange);

    el("exportJsonBtn").addEventListener("click", exportJson);
    el("importJsonBtn").addEventListener("click", () => el("importFile").click());
    el("importFile").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if (f) importJson(f);
      e.target.value = "";
    });

    el("exportChangesCsvBtn").addEventListener("click", exportChangesCSV);
    el("exportCfgCsvBtn").addEventListener("click", exportCfgCSV);
    el("exportSummaryCsvBtn").addEventListener("click", exportSummaryCSV);

    el("resetBtn").addEventListener("click", resetDraft);
    el("printBtn").addEventListener("click", () => window.print());
  })();
</script>
</body>
</html>
