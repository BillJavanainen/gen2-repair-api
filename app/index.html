<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gen2 Repair & Configuration Change Form</title>
  <style>
    :root { --bg:#0b0f14; --card:#121825; --muted:#8fa0b8; --text:#e8eef8; --line:#233044; --accent:#6ea8fe; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:linear-gradient(180deg,#070a0f 0%, #0b0f14 100%); color:var(--text);
    }
    header{
      padding:20px 18px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(11,15,20,.92); backdrop-filter: blur(10px); z-index:10;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:0 14px; }
    h1{ margin:0 0 6px 0; font-size:18px; font-weight:700; }
    .sub{ margin:0; color:var(--muted); font-size:12px; }
    main{ padding:18px 0 40px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media(min-width:980px){ .grid{ grid-template-columns: 1fr 1fr; } .full{ grid-column:1/-1; } }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 10px 0; font-size:14px; letter-spacing:.2px; }
    .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width:720px){ .row{ grid-template-columns: 1fr 1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, textarea, select{
      width:100%; border-radius:10px; border:1px solid var(--line); background:#0b111b; color:var(--text);
      padding:10px 10px; font-size:13px; outline:none;
    }
    textarea{ min-height:90px; resize:vertical; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    button{
      border:1px solid var(--line); background:#0b111b; color:var(--text);
      padding:9px 11px; border-radius:10px; cursor:pointer; font-size:13px;
    }
    button.primary{ background:rgba(110,168,254,.15); border-color:rgba(110,168,254,.35); }
    button.danger{ background:rgba(255,99,99,.12); border-color:rgba(255,99,99,.3); }
    button:hover{ border-color:#395072; }
    table{ width:100%; border-collapse:collapse; border-radius:12px; }
    th, td{
      border-bottom:1px solid var(--line); padding:8px 8px; vertical-align:top; font-size:12px;
    }
    th{ color:var(--muted); font-weight:600; text-align:left; }
    .pill{ display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted); font-size:11px;
    }
    .right{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .statusline{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .msg{ margin-top:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#0b111b; color:var(--muted); }
    .ok{ color:#9be9a8; }
    .bad{ color:#ff9b9b; }
  </style>
</head>
<body>
<header>
  <div class="wrap statusline">
    <div>
      <h1>Gen2 Repair & Configuration Change Form</h1>
      <p class="sub">Autosaves locally • Production API v3 • Database Sync Enabled</p>
    </div>
    <div class="right">
      <span id="savePill" class="pill">● <span class="mono" id="saveState">saved</span></span>
      <input id="apiBase" style="width:300px" value="https://gen2-repair-api-3.onrender.com" />
      <input id="apiKey" style="width:240px" type="password" value="some-long-random-string" />
      <button class="primary" id="submitDbBtn">Submit to Database</button>
      <button class="danger" id="resetBtn">Reset Draft</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <section class="card full">
      <h2>0) Connectivity Status</h2>
      <div class="btnbar">
        <button id="pingDocsBtn">Open API Docs</button>
        <button id="pingRepairsBtn">Check DB Connection</button>
      </div>
      <div id="statusBox" class="msg">Awaiting input...</div>
    </section>

    <section class="card">
      <h2>1) Vessel & Work Info</h2>
      <div class="row">
        <div>
          <label>Hull ID (R###)</label>
          <input id="hullId" placeholder="e.g. R134" />
        </div>
        <div>
          <label>Location</label>
          <input id="location" placeholder="Rumford / Field Site" />
        </div>
        <div>
          <label>Date Opened</label>
          <input id="dateOpened" type="date" />
        </div>
        <div>
          <label>Lead Technician(s)</label>
          <input id="techs" placeholder="Names" />
        </div>
        <div class="full">
          <label>Service Type</label>
          <select id="serviceType">
            <option value="">—</option>
            <option>Failure</option>
            <option>Preventative Maintenance</option>
            <option>Upgrade</option>
            <option>Standardization</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) Issue Description</h2>
      <textarea id="issueDesc" placeholder="Describe symptoms, conditions, and initial logs..."></textarea>
    </section>

    <section class="card full">
      <h2>3) Hardware Component Swaps</h2>
      <div class="row">
        <select id="chgSubsystem">
          <option value="">Select Subsystem—</option>
          <option>Ilmor</option><option>ICU</option><option>Orca</option><option>Starlink</option>
        </select>
        <input id="chgComponent" placeholder="Specific Component" />
        <input id="chgOldSn" placeholder="Old Serial #" />
        <input id="chgNewSn" placeholder="New Serial #" />
        <input id="chgReason" placeholder="Reason for swap" />
        <button class="primary" id="addChangeBtn">Add to Swap Log</button>
      </div>

      <table id="changesTable" style="margin-top:15px">
        <thead>
          <tr><th>Subsystem</th><th>Component</th><th>Old SN</th><th>New SN</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card full">
      <h2>4) Configuration Changes</h2>
      <div class="row">
        <select id="cfgSystem">
          <option value="">Select System—</option>
          <option>ArduPilot</option><option>Balena</option><option>Ilmor Config</option>
        </select>
        <input id="cfgParam" placeholder="Parameter Name" />
        <input id="cfgOld" placeholder="Old Value" />
        <input id="cfgNew" placeholder="New Value" />
        <input id="cfgReason" placeholder="Reason / Notes" />
        <button class="primary" id="addCfgBtn">Add to Config Log</button>
      </div>

      <table id="cfgTable" style="margin-top:15px">
        <thead>
          <tr><th>System</th><th>Parameter</th><th>Old</th><th>New</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>
</main>

<script>
  const LS_KEY = "gen2_repair_v3";
  const el = (id) => document.getElementById(id);
  const state = { meta: {}, componentChanges: [], configChanges: [] };

  function setStatus(msg, ok=true) {
    el("statusBox").innerHTML = msg;
    el("statusBox").className = "msg " + (ok ? "ok" : "bad");
  }

  function saveToLocal() {
    state.meta = {
      hull_id: el("hullId").value,
      location: el("location").value,
      date_opened: el("dateOpened").value,
      technicians: el("techs").value,
      service_type: el("serviceType").value,
      issue_desc: el("issueDesc").value
    };
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    el("saveState").textContent = "saved";
  }

  function loadLocal() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    Object.assign(state, data);
    el("hullId").value = state.meta.hull_id || "";
    el("location").value = state.meta.location || "";
    el("dateOpened").value = state.meta.date_opened || "";
    el("techs").value = state.meta.technicians || "";
    el("serviceType").value = state.meta.service_type || "";
    el("issueDesc").value = state.meta.issue_desc || "";
    renderAll();
  }

  function renderAll() {
    el("changesTable").querySelector("tbody").innerHTML = state.componentChanges.map((c, i) => `
      <tr><td>${c.subsystem}</td><td>${c.component}</td><td>${c.old_serial}</td><td>${c.new_serial}</td>
      <td><button onclick="removeIdx('comp', ${i})">Del</button></td></tr>`).join('');
    
    el("cfgTable").querySelector("tbody").innerHTML = state.configChanges.map((c, i) => `
      <tr><td>${c.system}</td><td>${c.parameter}</td><td>${c.old_value}</td><td>${c.new_value}</td>
      <td><button onclick="removeIdx('cfg', ${i})">Del</button></td></tr>`).join('');
  }

  function removeIdx(type, i) {
    if(type==='comp') state.componentChanges.splice(i,1);
    else state.configChanges.splice(i,1);
    renderAll(); saveToLocal();
  }

  el("addChangeBtn").onclick = () => {
    state.componentChanges.push({
      subsystem: el("chgSubsystem").value,
      component: el("chgComponent").value,
      old_serial: el("chgOldSn").value,
      new_serial: el("chgNewSn").value,
      reason: el("chgReason").value,
      change_date: el("dateOpened").value,
      performed_by: el("techs").value
    });
    renderAll(); saveToLocal();
  };

  el("addCfgBtn").onclick = () => {
    state.configChanges.push({
      system: el("cfgSystem").value,
      parameter: el("cfgParam").value,
      old_value: el("cfgOld").value,
      new_value: el("cfgNew").value,
      notes: el("cfgReason").value
    });
    renderAll(); saveToLocal();
  };

  async function apiFetch(path, method, body) {
    const res = await fetch(el("apiBase").value + path, {
      method: method,
      headers: { "Content-Type": "application/json", "X-API-Key": el("apiKey").value },
      body: body ? JSON.stringify(body) : null
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }

  el("submitDbBtn").onclick = async () => {
    try {
      setStatus("Syncing...");
      const repair = await apiFetch("/repairs", "POST", state.meta);
      const uid = repair.repair_uid;
      
      for(const c of state.componentChanges) await apiFetch(`/repairs/${uid}/component-changes`, "POST", c);
      for(const c of state.configChanges) await apiFetch(`/repairs/${uid}/config-changes`, "POST", c);
      
      setStatus("✅ Successfully submitted to Database.");
      alert("Submission Complete!");
    } catch(e) { setStatus("❌ Error: " + e.message, false); }
  };

  el("pingDocsBtn").onclick = () => window.open(el("apiBase").value + "/docs");
  el("resetBtn").onclick = () => { if(confirm("Clear draft?")) { localStorage.removeItem(LS_KEY); location.reload(); }};
  
  el("dateOpened").valueAsDate = new Date();
  loadLocal();
  document.querySelectorAll('input, select, textarea').forEach(i => i.addEventListener('input', saveToLocal));
</script>
</body>
</html>
