<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gen2 Repair Portal v3.1</title>
  <style>
    :root { --bg:#0b0f14; --card:#121825; --muted:#8fa0b8; --text:#e8eef8; --line:#233044; --accent:#6ea8fe; }
    * { box-sizing:border-box; }
    body {
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      background:#0b0f14; color:var(--text); line-height: 1.5;
    }
    header {
      padding:20px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(11,15,20,0.9); backdrop-filter:blur(10px); z-index:100;
    }
    .wrap { max-width:1100px; margin:0 auto; padding:0 20px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:20px; margin-bottom:20px; }
    h2 { margin:0 0 15px 0; font-size:14px; color:var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    label { display:block; font-size:11px; color:var(--muted); margin-bottom:5px; font-weight: 600; }
    input, textarea, select {
      width:100%; border-radius:8px; border:1px solid var(--line); background:#0b111b; color:var(--text);
      padding:10px; font-size:13px; outline:none; margin-bottom: 10px;
    }
    input:focus { border-color: var(--accent); }
    .btn-row { display:flex; gap:10px; flex-wrap: wrap; }
    button {
      padding:10px 16px; border-radius:8px; border:1px solid var(--line); 
      background:#1c2536; color:var(--text); cursor:pointer; font-size:13px; font-weight:600;
    }
    button:hover { background: #233044; border-color: var(--muted); }
    button.primary { background: var(--accent); color: #000; border: none; }
    button.danger { color: #ff9b9b; border-color: #442323; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
    th { text-align:left; color:var(--muted); border-bottom:1px solid var(--line); padding:10px; background: #0b111b; }
    td { padding:10px; border-bottom:1px solid var(--line); }
    .mono { font-family: monospace; color: var(--accent); }
    .status-bar { margin-top:10px; padding:10px; border-radius:8px; background:#0b111b; font-size:12px; border:1px solid var(--line); }
    .ok { color: #9be9a8; }
    .err { color: #ff9b9b; }
  </style>
</head>
<body>

<header>
  <div class="wrap" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
    <div>
      <h1 style="margin:0; font-size:20px;">Gen2 Repair Portal</h1>
      <div id="saveState" style="font-size:11px; color:var(--muted);">Autosave active</div>
    </div>
    <div class="btn-row">
      <input id="apiBase" style="width:260px; margin:0;" value="https://gen2-repair-api-3.onrender.com" />
      <input id="apiKey" style="width:160px; margin:0;" type="password" placeholder="API Key" value="some-long-random-string" />
      <button class="primary" id="submitDbBtn">Submit to DB</button>
      <button class="danger" id="resetBtn">Reset</button>
    </div>
  </div>
</header>

<main class="wrap" style="margin-top:30px;">
  <div id="statusBox" class="status-bar">System Ready. Fill out Hull ID to begin.</div>

  <div class="grid">
    <section class="card">
      <h2>1) Vessel & Service</h2>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div><label>Hull ID</label><input id="hullId" placeholder="R134" /></div>
        <div><label>Date</label><input id="dateOpened" type="date" /></div>
      </div>
      <label>Location</label><input id="location" placeholder="e.g. Rumford" />
      <label>Technicians</label><input id="techs" placeholder="Names" />
      <label>Issue Description</label>
      <textarea id="issueDesc" style="height:80px;" placeholder="What is broken?"></textarea>
    </section>

    <section class="card">
      <h2>2) Hardware Swaps</h2>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <select id="chgSub"><option value="">Subsystem—</option><option>Ilmor</option><option>ICU</option><option>Orca</option></select>
        <input id="chgComp" placeholder="Component" />
        <input id="chgOld" placeholder="Old S/N" />
        <input id="chgNew" placeholder="New S/N" />
      </div>
      <button style="width:100%" id="addSwapBtn">+ Add Swap to List</button>
      <table id="swapTable">
        <thead><tr><th>Component</th><th>Old S/N</th><th>New S/N</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card" style="grid-column: span 2;">
      <h2>3) Configuration Changes</h2>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px;">
        <input id="cfgParam" placeholder="Parameter" />
        <input id="cfgOldVal" placeholder="Old Val" />
        <input id="cfgNewVal" placeholder="New Val" />
        <button id="addCfgBtn">+ Add Config</button>
      </div>
      <table id="cfgTable">
        <thead><tr><th>Parameter</th><th>Old Value</th><th>New Value</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card" style="grid-column: span 2;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>4) Cloud History Log</h2>
        <button id="refreshLogBtn">Refresh from Cloud</button>
      </div>
      <div style="overflow-x:auto;">
        <table id="logTable">
          <thead><tr><th>Date</th><th>Hull</th><th>Techs</th><th>Issue</th><th>UID</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<script>
  const el = (id) => document.getElementById(id);
  const LS_KEY = "gen2_data_v3";
  let state = { meta: {}, swaps: [], configs: [] };

  function setStatus(msg, isErr=false) {
    el("statusBox").innerHTML = msg;
    el("statusBox").className = "status-bar " + (isErr ? "err" : "ok");
  }

  // --- LOCAL STORAGE ---
  function save() {
    state.meta = {
      hull_id: el("hullId").value.trim(),
      location: el("location").value.trim(),
      date_opened: el("dateOpened").value,
      technicians: el("techs").value.trim(),
      issue_desc: el("issueDesc").value.trim()
    };
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    el("saveState").textContent = "Draft saved: " + new Date().toLocaleTimeString();
  }

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    state = JSON.parse(raw);
    el("hullId").value = state.meta.hull_id || "";
    el("location").value = state.meta.location || "";
    el("dateOpened").value = state.meta.date_opened || "";
    el("techs").value = state.meta.technicians || "";
    el("issueDesc").value = state.meta.issue_desc || "";
    renderLists();
  }

  function renderLists() {
    el("swapTable").querySelector("tbody").innerHTML = state.swaps.map((s, i) => 
      `<tr><td>${s.component}</td><td class="mono">${s.old_serial}</td><td class="mono">${s.new_serial}</td><td><button onclick="removeSwap(${i})">×</button></td></tr>`).join('');
    
    el("cfgTable").querySelector("tbody").innerHTML = state.configs.map((c, i) => 
      `<tr><td class="mono">${c.parameter}</td><td>${c.old_value}</td><td>${c.new_value}</td><td><button onclick="removeCfg(${i})">×</button></td></tr>`).join('');
  }

  window.removeSwap = (i) => { state.swaps.splice(i,1); renderLists(); save(); };
  window.removeCfg = (i) => { state.configs.splice(i,1); renderLists(); save(); };

  // --- UI ACTIONS ---
  el("addSwapBtn").onclick = () => {
    if(!el("chgComp").value) return alert("Enter component name");
    state.swaps.push({
      subsystem: el("chgSub").value,
      component: el("chgComp").value,
      old_serial: el("chgOld").value,
      new_serial: el("chgNew").value,
      change_date: el("dateOpened").value
    });
    el("chgComp").value=""; el("chgOld").value=""; el("chgNew").value="";
    renderLists(); save();
  };

  el("addCfgBtn").onclick = () => {
    if(!el("cfgParam").value) return alert("Enter parameter name");
    state.configs.push({
      parameter: el("cfgParam").value,
      old_value: el("cfgOldVal").value,
      new_value: el("cfgNewVal").value
    });
    el("cfgParam").value=""; el("cfgOldVal").value=""; el("cfgNewVal").value="";
    renderLists(); save();
  };

  // --- API LOGIC ---
  async function api(path, method="GET", body=null) {
    const baseUrl = el("apiBase").value.trim().replace(/\/+$/, "");
    const options = {
      method,
      mode: 'cors',
      headers: { 
        "Content-Type": "application/json", 
        "X-API-Key": el("apiKey").value.trim() 
      },
      body: body ? JSON.stringify(body) : null
    };
    const res = await fetch(`${baseUrl}${path}`, options);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    return res.json();
  }

  el("submitDbBtn").onclick = async () => {
    try {
      if (!el("hullId").value) return alert("Hull ID required");
      el("submitDbBtn").disabled = true;
      
      setStatus("Step 1/3: Creating Repair Record...");
      const repair = await api("/repairs", "POST", state.meta);
      const uid = repair.repair_uid;

      if(state.swaps.length) {
        setStatus(`Step 2/3: Uploading ${state.swaps.length} Swaps...`);
        for (const s of state.swaps) await api(`/repairs/${uid}/component-changes`, "POST", s);
      }

      if(state.configs.length) {
        setStatus(`Step 3/3: Uploading ${state.configs.length} Configs...`);
        for (const c of state.configs) await api(`/repairs/${uid}/config-changes`, "POST", c);
      }

      setStatus("✅ Sync Complete.");
      alert("Submitted successfully!");
      refreshLog();
    } catch (e) { 
      setStatus("❌ Submission Error: " + e.message, true); 
    } finally {
      el("submitDbBtn").disabled = false;
    }
  };

  async function refreshLog() {
    try {
      setStatus("Refreshing history...");
      const data = await api("/repairs");
      data.sort((a,b) => new Date(b.date_opened) - new Date(a.date_opened));
      el("logTable").querySelector("tbody").innerHTML = data.map(r => `
        <tr><td>${r.date_opened}</td><td class="mono" style="font-weight:bold">${r.hull_id}</td><td>${r.technicians}</td><td>${r.issue_desc}</td><td class="mono" style="font-size:10px">${r.repair_uid.slice(0,8)}</td></tr>
      `).join('');
      setStatus("History updated.");
    } catch (e) { setStatus("Fetch Error: " + e.message, true); }
  }

  el("refreshLogBtn").onclick = refreshLog;
  el("resetBtn").onclick = () => { if(confirm("Clear draft?")) { localStorage.clear(); location.reload(); } };

  // Init
  el("dateOpened").valueAsDate = new Date();
  load();
  document.querySelectorAll('input, textarea, select').forEach(i => i.oninput = save);
</script>
</body>
</html>
